# detection_service/repetitive_phrasing_detector.py\n\nfrom kafka import KafkaConsumer\nimport json\nimport psycopg2\nimport datetime\nimport re\nfrom collections import Counter\n\n# Configuration\nKAFKA_BROKER = \"localhost:9092\"\nKAFKA_TOPIC_REVIEWS = \"amazon_reviews_raw\"\nDB_HOST = \"localhost\"\nDB_NAME = \"review_abuse_db\"\nDB_USER = \"user\"\nDB_PASSWORD = \"password\"\n\n# Repetitive phrasing thresholds\nMIN_PHRASE_LENGTH = 3\nMAX_PHRASE_LENGTH = 5\nREPETITION_COUNT_THRESHOLD = 2 # How many times a phrase must repeat to be flagged\n\nconsumer = KafkaConsumer(\n    KAFKA_TOPIC_REVIEWS,\n    bootstrap_servers=[KAFKA_BROKER],\n    auto_offset_reset='latest',\n    enable_auto_commit=True,\n    group_id='repetitive-phrasing-detector-group',\n    value_deserializer=lambda x: json.loads(x.decode('utf-8'))\n)\n\ndef get_db_connection():\n    return psycopg2.connect(host=DB_HOST, database=DB_NAME, user=DB_USER, password=DB_PASSWORD)\n\ndef normalize_text(text):\n    \"\"\"Removes punctuation and converts to lowercase.\"\"\"\n    text = text.lower()\n    text = re.sub(r'[^\w\\s]', '', text) # Remove punctuation\n    return text\n\ndef extract_phrases(text, min_len, max_len):\n    \"\"\"Extracts phrases of specified lengths from the text.\"\"\"\n    words = text.split()\n    phrases = []\n    for length in range(min_len, max_len + 1):\n        for i in range(len(words) - length + 1):\n            phrase = \" \".join(words[i:i+length])\n            phrases.append(phrase)\n    return phrases\n\ndef detect_repetitive_phrasing(review):\n    \"\"\"\n    Detects repetitive phrasing patterns in a given review's text.\n    \"\"\"\n    conn = None\n    try:\n        conn = get_db_connection()\n        cur = conn.cursor()\n\n        review_id = review['reviewId']\n        review_text = review.get('reviewText', '')\n\n        if not review_text:\n            print(f\"Review {review_id} has no text, skipping repetitive phrasing detection.\")\n            return\n\n        normalized_review_text = normalize_text(review_text)\n        phrases = extract_phrases(normalized_review_text, MIN_PHRASE_LENGTH, MAX_PHRASE_LENGTH)\n\n        phrase_counts = Counter(phrases)\n\n        flagged = False\n        reasons = []\n        abuse_score_increment = 0.0\n        \n        for phrase, count in phrase_counts.items():\n            if count >= REPETITION_COUNT_THRESHOLD:\n                flagged = True\n                reasons.append(f\"Repetitive_Phrasing: '{phrase}' repeated {count} times\")\n                abuse_score_increment += 0.25 # Can be dynamic based on repetition severity\n                break # Flag once, can be modified to collect all reasons\n\n        if flagged:\n            print(f\"Flagging review {review_id} for repetitive phrasing. Reasons: {reasons}\")\n            # Update the review in the database\n            # We use array_cat to add all reasons if there are multiple.\n            # If flagging_reason is an empty array initially, array_cat will handle it.\n            cur.execute(\n                \"\"\"\n                UPDATE reviews\n                SET is_flagged = TRUE,\n                    flagging_reason = array_cat(flagging_reason, %s::TEXT[]),\n                    flagging_timestamp = %s,\n                    abuse_score = abuse_score + %s\n                WHERE review_id = %s;\n                \"\"\",\n                (reasons, datetime.datetime.now(), abuse_score_increment, review_id)\n            )\n            conn.commit()\n        else:\n            print(f\"Review {review_id} passed repetitive phrasing checks.\")\n\n    except psycopg2.Error as e:\n        print(f\"Database error in repetitive phrasing detection for review {review.get('reviewId')}: {e}\")\n    except Exception as e:\n        print(f\"An unexpected error occurred in repetitive phrasing detection: {e}\")\n    finally:\n        if conn:\n            conn.close()\n\ndef run_repetitive_phrasing_detector():\n    print(\"Starting repetitive phrasing detection module...\")\n    for message in consumer:\n        review = message.value\n        print(f\"Processing review for repetitive phrasing detection: {review.get('reviewId')}\")\n        detect_repetitive_phrasing(review)\n\nif __name__ == \"__main__\":\n    run_repetitive_phrasing_detector()\n