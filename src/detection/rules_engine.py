from abc import ABC, abstractmethod\nfrom typing import List, Tuple, Optional\nfrom datetime import datetime\n\nfrom src.data_models.review_model import Review, AbuseFlag, DetectionResults\n\n# --- Rule Interface (Abstract Base Class) ---\nclass Rule(ABC):\n    def __init__(self, rule_id: str, description: str):\n        if not rule_id or not description:\n            raise ValueError(\"Rule ID and description cannot be empty.\")\n        self.rule_id = rule_id\n        self.description = description\n\n    @abstractmethod\n    def evaluate(self, review: Review) -> Tuple[bool, Optional[str]]:\n        \"\"\"\n        Evaluates a review against this specific rule.\n        Returns a tuple: (is_triggered: bool, reason_message: Optional[str])\n        - is_triggered: True if the rule is violated, False otherwise.\n        - reason_message: A brief message explaining why the rule was triggered,\n                          or None if not triggered.\n        \"\"\"\
        pass\n\n# --- Rules Engine ---\nclass RulesEngine:\n    def __init__(self):\n        self._rules: List[Rule] = []\n\n    def add_rule(self, rule: Rule):\n        \"\"\"Adds a rule to the engine.\"\"\"\
        if not isinstance(rule, Rule):\n            raise TypeError(\"Only instances of Rule can be added to the RulesEngine.\")\n        self._rules.append(rule)\n\n    def evaluate_review(self, review: Review) -> Review:\n        \"\"\"\n        Evaluates a review against all registered rules and updates its detection results.\n        The review object is modified in place to include any triggered abuse flags\n        and updated detection results.\n        Returns the updated review object.\n        \"\"\"\
        triggered_rules_ids = []\n        for rule in self._rules:\n            is_triggered, reason = rule.evaluate(review)\n            if is_triggered:\n                triggered_rules_ids.append(rule.rule_id)\n                # Add a new AbuseFlag to the review\n                review.abuseFlags.append(\n                    AbuseFlag(\n                        ruleId=rule.rule_id,\n                        flaggedAt=datetime.utcnow(),\n                        reason=reason if reason else rule.description # Use specific reason or default description\n                    )\n                )\n\n        # Update the DetectionResults on the review object\n        review.detectionResults.triggeredRules = triggered_rules_ids\n\n        # Other specific detection results (e.g., suspiciousKeywords, identicalReview)\n        # will be updated by their respective rule implementations in subsequent tasks.\n\n        return review\n