\nimport json\nimport base64\nimport os\nfrom datetime import datetime\nfrom elasticsearch import Elasticsearch\n\n# Environment variables\nES_HOST = os.environ.get('ES_HOST', 'localhost')\nES_PORT = int(os.environ.get('ES_PORT', 9200))\nES_INDEX = os.environ.get('ES_INDEX', 'amazon_reviews')\nBANNED_KEYWORDS = json.loads(os.environ.get('BANNED_KEYWORDS', '[]'))\nSUSPICIOUS_PHRASES = json.loads(os.environ.get('SUSPICIOUS_PHRASES', '[]'))\n\ndef init_elasticsearch_client():\n    # In a real scenario, use AWS SigV4 for OpenSearch Service or proper auth\n    return Elasticsearch([{'host': ES_HOST, 'port': ES_PORT, 'scheme': 'http'}])\n\ndef detect_abuse(review_text):\n    flag_reasons = []\n    normalized_text = review_text.lower()\n\n    for keyword in BANNED_KEYWORDS:\n        if keyword.lower() in normalized_text:\n            flag_reasons.append(f\"BANNED_KEYWORD:{keyword}\")\n\n    for phrase in SUSPICIOUS_PHRASES:\n        if phrase.lower() in normalized_text:\n            flag_reasons.append(f\"SUSPICIOUS_PHRASE:{phrase}\")\n\    # More sophisticated NLP or ML models could be integrated here\n    return flag_reasons\n\ndef lambda_handler(event, context):\n    es_client = init_elasticsearch_client()\n    records_processed = 0\n    records_failed = 0\n\n    for record in event['Records']:\n        try:\n            # Kinesis data is base64 encoded\n            payload = base64.b64decode(record['kinesis']['data']).decode('utf-8')\n            review_data = json.loads(payload)\n\n            # --- Keyword & Phrase-Based Flagging (Task 1.2.3 & 1.2.4) ---\n            flag_reasons = detect_abuse(review_data.get('review_text', ''))\n            if flag_reasons:\n                review_data['is_flagged'] = True\n                review_data['flag_reasons'] = flag_reasons\n            else:\n                review_data['is_flagged'] = False\n                review_data['flag_reasons'] = []\n\n            # Add default manual action fields\n            review_data['manual_status'] = 'pending'\n            review_data['manual_reason'] = None\n            review_data['manual_tags'] = []\n\n            # Index into Elasticsearch (Task 1.1.3)\n            es_client.index(\n                index=ES_INDEX,\n                id=review_data['review_id'], # Use review_id as Elasticsearch document ID\n                document=review_data\n            )\n            records_processed += 1\n\n        except Exception as e:\n            print(f\"Error processing record: {e}\")\n            print(f\"Record data: {record['kinesis']['data']}\")\n            records_failed += 1\n\n    print(f\"Successfully processed {records_processed} records, failed {records_failed} records.\")\n    return {\n        'statusCode': 200,\n        'body': json.dumps(f'Processed {records_processed} records, failed {records_failed}')\n    }\n\n